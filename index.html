<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amini - Personal Security App</title>
    <link rel="stylesheet" href="style.css">

    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    
    <meta name="theme-color" content="#232938">
    
    <title>Amini App | Secure SOS Alerts</title>

    <style>
    /* 1. Force forms to the very top layer */
    #login-container, #register-container, #login-form, #register-form {
        position: relative !important;
        z-index: 9999 !important;
        display: block; /* Ensure they aren't collapsed */
    }

    /* 2. Make the inputs specifically 'punch through' any overlays */
    input[type="password"], input[type="email"], input[type="text"] {
        position: relative !important;
        z-index: 10000 !important;
        cursor: text !important;
        pointer-events: auto !important;
        background-color: #fff !important; /* Ensure visibility */
    }

    /* 3. The eye icon button */
    #passwordToggle {
        z-index: 10001 !important;
        cursor: pointer !important;
    }

    /* 4. Kill any invisible branding layer that might be hanging over the middle of the screen */
    .app-branding, header, .logo-section {
        pointer-events: none; /* Mouse clicks go THROUGH this layer */
    }
    
    /* Re-enable clicks for branding content specifically if needed */
    .app-branding h1, .app-branding img {
        pointer-events: auto;
    }

    #passwordToggle {
    width: 40px !important;   /* Limits the monkey icon's width */
    height: 40px !important;  /* Limits the monkey icon's height */
    pointer-events: auto !important;
    }

    #passwordInput {
    padding-right: 50px !important; /* Forces text and mouse-clicks to stay left of the monkey */
    }
    #register-container {
    display: none; /* This hides the register form on page load */
    }

    #login-container {
    display: block; /* This ensures the login form is the first thing seen */
    }

    #register-container {
    display: none !important; /* Forces it to stay hidden on load */
    }

    #login-container {
    display: block !important;
    }

    /* This class will be used by JS to switch screens */
    .hidden {
    display: none !important;
    }
    #register-container { display: none !important; }
    #login-container { display: block !important; }
</style>
    </style>  
  </head>
 <body>
    

  <body>
  <div class="app-container">
    <div class="app-branding">
      <h1>Amini- Personal Security App</h1>
      <p>Your secure peace of mind.</p>
    </div>

    <section id="auth-screens">
      <div id="login-container">
        <h2>Login to Amini</h2>
        <form id="login-form">
          <div><label>Email</label><br><input type="email" id="login-email" required></div>
          <div><label>Password</label><br><input type="password" id="login-password" required></div>
          <button type="submit">Login</button>
          <p id="login-message-area"></p>
          <p>Need an account? <a href="#" id="show-register-link">Sign Up</a></p>
        </form>
      </div>

      <div id="register-container" style="display: none;">
        <h2>Register for Amini</h2>
        <form id="register-form">
          <div><label>Email</label><br><input type="email" id="register-email" required></div>
          <div class="input-group" style="position: relative;">
            <label>Password</label><br>
            <input type="password" id="passwordInput" required style="width: 100%; padding-right: 45px;">
            <button type="button" id="passwordToggle" style="position: absolute; right: 10px; bottom: 5px;">
              <span id="toggleIcon">üëÅÔ∏è</span>
            </button>
          </div>
          <button type="submit">Register</button>
          <p id="message-area"></p>
          <p>Already have an account? <a href="#" id="show-login-link">Log In</a></p>
        </form>
      </div>
    </section>

    <section id="main-app" class="hidden" style="display: none;">
      <h2 id="welcome-message">Welcome!</h2>

      <div id="sos-circle" style="margin: 40px auto; width: 200px; height: 200px; background-color: red; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 8px solid #800000; box-shadow: 0 10px 20px rgba(0,0,0,0.3);">
        <span style="color: white; font-weight: bold; font-size: 2rem; user-select: none;">SEND SOS</span>
      </div>

      <p id="sos-status" style="font-weight: bold; text-align: center;"></p>
      <p id="location-display" style="font-family: monospace; font-size: 0.9rem; color: #555; text-align: center;"></p>

      <div id="contacts-section" style="margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
        <h3>Emergency Contacts</h3>
        <div id="contact-list" style="margin-bottom: 10px;"></div>
        <input type="tel" id="new-contact" placeholder="+2348000000000" style="padding: 8px;">
        <button onclick="saveContact()" style="padding: 8px; background: #28a745; color: white; border: none; cursor: pointer;">Add Contact</button>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 10px;">
    <a href="tel:911" style="background: orange; color: white; padding: 10px; text-decoration: none; border-radius: 5px;">Call 911</a>
    <a href="tel:112" style="background: orange; color: white; padding: 10px; text-decoration: none; border-radius: 5px;">Call 112</a>
</div>

      <div style="margin-top: 20px;">
        <h3>Secure Communication</h3>
        <div id="secure-message-section">
          <input type="text" id="secure-message-input" placeholder="Type a secure message..." style="width: 80%; padding: 8px;">
          <button id="send-message-btn" class="sos-button">Send</button>
          <p id="status-log"></p>
        </div>
      </div>

      <div style="margin-top: 20px;">
        <h3>Activity Log</h3>
        <div id="activity-log" style="background: #f9f9f9; padding: 10px; min-height: 50px;"></div>
      </div>

      <button id="logout-btn" style="margin-top: 30px; background: #666; color: white;">Logout</button>
    </section>
  </div>

  <script type="module">
    
// ==========================================
// 1. DEBUG & INITIALIZATION
// ==========================================
console.log("Amini Master Script Active");

const loginContainer = document.getElementById('login-container');
const registerContainer = document.getElementById('register-container');
const showRegisterLink = document.getElementById('show-register-link');
const showLoginLink = document.getElementById('show-login-link');

// ==========================================
// 2. PASSWORD TOGGLE LOGIC
// ==========================================
const passwordToggle = document.getElementById('passwordToggle');
const passwordInput = document.getElementById('passwordInput');
const toggleIcon = document.getElementById('toggleIcon');

if (passwordToggle && passwordInput) {
    passwordToggle.addEventListener('click', (e) => {
        e.preventDefault(); // Extra safety
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';
        if (toggleIcon) toggleIcon.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
    });
}
// ==========================================
// 3. SCREEN SWITCHING (FIXED & AGGRESSIVE)
// ==========================================
if (showRegisterLink && loginContainer && registerContainer) {
    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        console.log("Switching to Register...");
        loginContainer.style.setProperty('display', 'none', 'important');
        registerContainer.style.setProperty('display', 'block', 'important');
    });
}

if (showLoginLink && loginContainer && registerContainer) {
    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        console.log("Switching to Login...");
        registerContainer.style.setProperty('display', 'none', 'important');
        loginContainer.style.setProperty('display', 'block', 'important');
    });
}

// ==========================================
// 4. LOGIN LOGIC (CORRECTED)
// ==========================================
const loginForm = document.getElementById('login-form');

if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const messageArea = document.getElementById('login-message-area');

        try {
            const response = await fetch('login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (response.ok) {
                // Store the security token
                localStorage.setItem('token', data.token);

                messageArea.style.color = "green";
                messageArea.textContent = "Login successful! Loading dashboard...";

                // Wait 1.5 seconds so the user can see the success message
                setTimeout(() => {
                    // 1. Hide the entire authentication section
                    const authScreens = document.getElementById('auth-screens');
                    if (authScreens) {
                        authScreens.style.setProperty('display', 'none', 'important');
                    }

                    // 2. Show the Main App section
                    const mainApp = document.getElementById('main-app');
                    if (mainApp) {
                        mainApp.classList.remove('hidden');
                        mainApp.style.setProperty('display', 'block', 'important');
                    }

                    // 3. Update the welcome message with the user's email
                    const welcomeMsg = document.getElementById('welcome-message');
                    if (welcomeMsg) {
                        welcomeMsg.textContent = `Welcome, ${email}!`;
                    }
                }, 1500);

            } else {
                messageArea.style.color = "red";
                messageArea.textContent = data.message || "Invalid credentials";
            }
        } catch (err) {
            console.error("Login error:", err);
            messageArea.style.color = "red";
            messageArea.textContent = "Server error. Check connection.";
        }
    });
}
// ==========================================
// 5. REGISTER LOGIC
// ==========================================
const registerForm = document.getElementById('register-form');
if (registerForm) {
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('passwordInput').value;
        const messageArea = document.getElementById('message-area');

        try {
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ 
                    email: email.trim(), 
                    password: password 
                })
            });
            const data = await response.json();
            if (response.ok) {
                messageArea.style.color = "green";
                messageArea.textContent = "Account created! Switching to login...";
                setTimeout(() => showLoginLink.click(), 2000);
            } else {
                messageArea.style.color = "red";
                
                messageArea.textContent = data.message || "Registration failed";
            }
        } catch (err) {
            messageArea.textContent = "Database connection error.";
        }
    });
}

// ==========================================
// 6. LOGOUT LOGIC
// ==========================================
const logoutBtn = document.getElementById('logout-btn');
if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
        // Clear the token from storage
        localStorage.removeItem('token');
        // Refresh the page to show the login screen again
        window.location.reload();
    });
}

// ==========================================
// 7. SOS & LOCATION LOGIC
// ==========================================
const sosButton = document.getElementById('sos-circle');
const sosStatus = document.getElementById('sos-status');
const locationDisplay = document.getElementById('location-display');

if (sosButton) {
    sosButton.addEventListener('click', () => {
        sosStatus.textContent = "Detecting location...";
        sosStatus.style.color = "orange";

        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                locationDisplay.textContent = `Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`;

                // --- NEW CODE STARTS HERE ---
                try {
                    const token = localStorage.getItem('token'); 
                    const response = await fetch('/api/report', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'x-auth-token': token 
                        },
                        body: JSON.stringify({ 
                             message: "SOS TRIGGERED", // 3. Added required message field
                             location: { latitude: lat, longitude: lon } // 4. Structured location correctly
                        })
                    });

                    if (response.ok) {
                        sosStatus.textContent = "ALERTS SENT SUCCESSFULLY!";
                        sosStatus.style.color = "green";
                    } else {
                        const errorData = await response.json();
                        sosStatus.textContent = errorData.message || "Server refused alert.";
                        sosStatus.style.color = "red";
                    }
                } catch (err) {
                    console.error("Connection error:", err);
                    sosStatus.textContent = "Network Error.";
                }
                // --- NEW CODE ENDS HERE ---

            }, (error) => {
                sosStatus.textContent = "Location denied.";
                sosStatus.style.color = "red";
            });
        }
    });
}

        // Function to save a new contact to the database
async function saveContact() {
    const contactInput = document.getElementById('new-contact');
    const phoneNumber = contactInput.value.trim();
    const token = localStorage.getItem('token');

    if (!phoneNumber) return alert("Please enter a number");

    try {
        const response = await fetch('/api/users/contacts', {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json',
                'x-auth-token': token 
            },
            body: JSON.stringify({ contact: phoneNumber })
        });

        if (response.ok) {
            alert("Contact added successfully!");
            contactInput.value = "";
            // Optionally: Refresh the list
        } else {
            alert("Failed to save contact. Make sure you are logged in.");
        }
    } catch (err) {
        console.error("Error saving contact:", err);
    }
}

  </script>
</body>

</html>
